<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JT/T 809-2019 å¹³å°ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .auto-refresh label {
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
        }

        .auto-refresh select {
            padding: 6px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #48bb78;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card .label {
            color: #718096;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            color: #2d3748;
            font-size: 32px;
            font-weight: 700;
        }

        .platforms {
            display: grid;
            gap: 20px;
        }

        .platform-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s;
        }

        .platform-card:hover {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .platform-header {
            padding: 24px;
            user-select: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: start;
        }

        .platform-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .platform-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .platform-id {
            font-size: 14px;
            color: #718096;
        }

        .status-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.online {
            background: #48bb78;
            box-shadow: 0 0 8px rgba(72, 187, 120, 0.5);
        }

        .status-dot.offline {
            background: #f56565;
        }

        .status-label {
            color: #4a5568;
            font-weight: 500;
        }

        .status-value {
            color: #718096;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge-info {
            background: #bee3f8;
            color: #2c5282;
        }

        .expand-icon {
            transition: transform 0.3s;
            font-size: 20px;
            color: #a0aec0;
        }

        .platform-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .vehicles-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .platform-card.expanded .vehicles-section {
            max-height: 2000px;
        }

        .vehicles-container {
            padding: 0 24px 24px;
            border-top: 1px solid #e2e8f0;
        }

        .vehicles-header {
            padding: 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }

        .vehicles-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .vehicles-table thead {
            background: #f7fafc;
        }

        .vehicles-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .vehicles-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }

        .vehicles-table tbody tr:hover {
            background: #f7fafc;
        }

        .vehicle-color {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .color-1 { background: #3182ce; color: white; }
        .color-2 { background: #ecc94b; color: #2d3748; }
        .color-3 { background: #2d3748; color: white; }
        .color-4 { background: #f7fafc; color: #2d3748; border: 1px solid #cbd5e0; }
        .color-5 { background: #48bb78; color: white; }
        .color-9 { background: #a0aec0; color: white; }
        .color-91 { background: #d69e2e; color: white; }
        .color-92 { background: #38a169; color: white; }
        .color-93 { background: #9ae6b4; color: #2d3748; }
        .color-94 { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .time {
            color: #718096;
            font-size: 13px;
        }

        .coord {
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .controls {
                flex-direction: column;
                width: 100%;
            }

            .btn, .auto-refresh {
                width: 100%;
                justify-content: center;
            }

            .platform-header {
                grid-template-columns: 1fr;
            }

            .vehicles-table {
                font-size: 12px;
            }

            .vehicles-table th,
            .vehicles-table td {
                padding: 8px 4px;
            }
        }

        .heartbeat-info {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        .link-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .link-info-item {
            font-size: 13px;
            color: #4a5568;
        }

        .link-info-label {
            font-weight: 600;
            color: #2d3748;
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            margin-left: 6px;
            background: #e2e8f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #4a5568;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #cbd5e0;
            color: #2d3748;
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        .copy-btn.copied {
            background: #48bb78;
            color: white;
        }

        .copyable {
            display: inline-flex;
            align-items: center;
        }

        .action-cell {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #edf2f7;
            color: #2d3748;
        }

        .action-btn:hover:not(:disabled) {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        .action-btn:disabled {
            cursor: not-allowed;
            opacity: 0.55;
        }

        .action-btn.action-play {
            background: #667eea;
            color: white;
        }

        .action-btn.action-play:hover:not(:disabled) {
            background: #5568d3;
        }

        .hidden {
            display: none !important;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 16px;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: min(360px, 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
        }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }

        .channel-btn {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f7fafc;
            cursor: pointer;
            font-weight: 600;
            color: #2d3748;
            transition: all 0.2s ease;
        }

        .channel-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
        }

        .modal-cancel {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            background: #e2e8f0;
            color: #4a5568;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .modal-cancel:hover {
            background: #cbd5e0;
        }

        .player-overlay {
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .player-dialog {
            background: linear-gradient(135deg, #0f172a, #111827);
            border-radius: 14px;
            width: min(980px, 100%);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
            border: 1px solid #1f2937;
            color: #e2e8f0;
        }

        .player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px 6px;
        }

        .player-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .player-close {
            border: none;
            background: transparent;
            color: #cbd5e0;
            font-size: 18px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .player-close:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-1px);
        }

        .player-body {
            position: relative;
            padding: 0 18px 18px 18px;
        }

        .player-video {
            width: 100%;
            height: 60vh;
            max-height: 60vh;
            background: #000;
            border-radius: 10px;
            border: 1px solid #1f2937;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        .player-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
            color: #cbd5e0;
            gap: 12px;
        }

        .player-status {
            color: #7dd3fc;
            font-weight: 600;
        }

        .channel-tabs {
            position: absolute;
            right: -69px;
            bottom: 50px;
            top: auto;
            transform: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: auto;
            align-items: flex-end;
        }

        .channel-tab-btn {
            width: 68px;
            padding: 10px 8px;
            background: #667eea;
            color: white;
            border: 1px solid #5568d3;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            transition: all 0.2s ease;
        }

        .channel-tab-btn:hover {
            transform: translateX(-2px);
            background: #5568d3;
            border-color: #4c51bf;
        }

        .channel-tab-btn.active {
            background: #4c51bf;
            color: white;
            border-color: #434190;
            box-shadow: 0 8px 20px rgba(67, 79, 206, 0.35);
            transform: translateX(-2px);
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(45, 55, 72, 0.9);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            animation: fadeInUp 0.2s ease, fadeOut 0.3s ease 2.2s forwards;
        }

        .toast-emoji {
            font-size: 16px;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, 8px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translate(-50%, 8px); }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/flv.js@1.6.2/dist/flv.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— JT/T 809-2019 å¹³å°ç›‘æ§ç³»ç»Ÿ</h1>
            <div class="controls">
                <div class="auto-refresh">
                    <label class="switch">
                        <input type="checkbox" id="autoRefreshToggle" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="autoRefreshToggle">è‡ªåŠ¨åˆ·æ–°</label>
                    <select id="refreshInterval">
                        <option value="5">5ç§’</option>
                        <option value="10" selected>10ç§’</option>
                        <option value="30">30ç§’</option>
                        <option value="60">60ç§’</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="loadData()">
                    <span>ğŸ”„</span>
                    <span>ç«‹å³åˆ·æ–°</span>
                </button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="label">åœ¨çº¿å¹³å°</div>
                <div class="value" id="onlinePlatforms">0</div>
            </div>
            <div class="stat-card">
                <div class="label">æ€»å¹³å°æ•°</div>
                <div class="value" id="totalPlatforms">0</div>
            </div>
            <div class="stat-card">
                <div class="label">æ€»è½¦è¾†æ•°</div>
                <div class="value" id="totalVehicles">0</div>
            </div>
            <div class="stat-card">
                <div class="label">ç›‘æ§ä¸­è½¦è¾†</div>
                <div class="value" id="monitoredVehicles">0</div>
            </div>
        </div>

        <div id="platformsContainer" class="platforms">
            <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
    </div>

    <div id="playerOverlay" class="modal-overlay player-overlay hidden" aria-hidden="true">
        <div class="player-dialog" role="dialog" aria-modal="true">
            <div class="player-header">
                <div class="player-title" id="playerTitle">ç›´æ’­æ’­æ”¾</div>
                <button class="player-close" onclick="closePlayerModal()" aria-label="å…³é—­æ’­æ”¾å™¨">âœ•</button>
            </div>
            <div class="player-body">
                <div class="channel-tabs" aria-label="é€šé“é€‰æ‹©">
                    <button class="channel-tab-btn" data-channel="1">é€šé“ 1</button>
                    <button class="channel-tab-btn" data-channel="2">é€šé“ 2</button>
                    <button class="channel-tab-btn" data-channel="3">é€šé“ 3</button>
                    <button class="channel-tab-btn" data-channel="4">é€šé“ 4</button>
                </div>
                <video id="flvPlayer" class="player-video" controls autoplay playsinline></video>
                <div class="player-meta">
                    <span id="playerInfo"></span>
                    <span id="playerStatus" class="player-status">ç­‰å¾…æ’­æ”¾</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshTimer = null;
        const AUDIO_VIDEO_FLAG = 2;
        const currentOrigin = `${window.location.protocol}//${window.location.host}`;
        let flvPlayerInstance = null;
        let playerOverlay = null;
        let playerVideo = null;
        let playerStatus = null;
        let playerInfo = null;
        let playerTitle = null;
        let channelButtons = [];
        let playbackContext = null;

        // è½¦ç‰Œé¢œè‰²æ˜ å°„
        const vehicleColorMap = {
            1: { name: 'è“è‰²', class: 'color-1' },
            2: { name: 'é»„è‰²', class: 'color-2' },
            3: { name: 'é»‘è‰²', class: 'color-3' },
            4: { name: 'ç™½è‰²', class: 'color-4' },
            5: { name: 'ç»¿è‰²', class: 'color-5' },
            9: { name: 'å…¶ä»–', class: 'color-9' },
            0x91: { name: 'å†œé»„è‰²', class: 'color-91' },
            0x92: { name: 'å†œç»¿è‰²', class: 'color-92' },
            0x93: { name: 'é»„ç»¿è‰²', class: 'color-93' },
            0x94: { name: 'æ¸å˜ç»¿', class: 'color-94' }
        };

        function escapeAttr(value) {
            return String(value ?? '').replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text, button) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘çˆ¶å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶
            const evt = window.event;
            if (evt && typeof evt.stopPropagation === 'function') {
                evt.stopPropagation();
            }

            // å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(button);
                }).catch(err => {
                    console.error('Clipboard API å¤±è´¥:', err);
                    fallbackCopy(text, button);
                });
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                fallbackCopy(text, button);
            }
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸ
        function showCopySuccess(button) {
            const originalText = button.textContent;
            button.textContent = 'âœ“';
            button.classList.add('copied');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('copied');
            }, 2000);
        }

        // é™çº§å¤åˆ¶æ–¹æ¡ˆ
        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(button);
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + text);
                }
            } catch (err) {
                console.error('é™çº§å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + text);
            }
            document.body.removeChild(textarea);
        }

        // åˆ›å»ºå¤åˆ¶æŒ‰é’®
        function createCopyButton(text) {
            return `<button class="copy-btn" onclick="copyToClipboard('${text}', this)" title="å¤åˆ¶">ğŸ“‹</button>`;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            if (!timeStr || timeStr === '0001-01-01T00:00:00Z') {
                return 'ä»æœª';
            }
            const date = new Date(timeStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return `${diff}ç§’å‰`;
            if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}å¤©å‰`;

            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ ¼å¼åŒ–åæ ‡
        function formatCoord(value) {
            return value ? value.toFixed(6) : 'N/A';
        }

        function buildPlaybackURL({ serverIP, serverPort, plate, color, channel, avFlag, authCode }) {
            return `${currentOrigin}/proxy/rtp.flv?url=http://${serverIP}:${serverPort}/${plate}.${color}.${channel}.${avFlag}.${authCode}`;
        }

        function ensurePlayerElements() {
            if (playerOverlay) return;
            playerOverlay = document.getElementById('playerOverlay');
            playerVideo = document.getElementById('flvPlayer');
            playerStatus = document.getElementById('playerStatus');
            playerInfo = document.getElementById('playerInfo');
            playerTitle = document.getElementById('playerTitle');
            channelButtons = Array.from(document.querySelectorAll('.channel-tab-btn'));
            channelButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = Number(btn.dataset.channel);
                    startPlaybackForChannel(val);
                });
            });

            if (playerOverlay) {
                playerOverlay.addEventListener('click', e => {
                    if (e.target === playerOverlay) {
                        closePlayerModal();
                    }
                });
            }

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape' && playerOverlay && !playerOverlay.classList.contains('hidden')) {
                    closePlayerModal();
                }
            });
        }

        function setActiveChannelButton(channel) {
            if (!channelButtons || channelButtons.length === 0) return;
            channelButtons.forEach(btn => {
                const val = Number(btn.dataset.channel);
                btn.classList.toggle('active', val === channel);
            });
        }

        function destroyFlvPlayer() {
            if (flvPlayerInstance) {
                try {
                    flvPlayerInstance.unload();
                    flvPlayerInstance.detachMediaElement();
                    flvPlayerInstance.destroy();
                } catch (err) {
                    console.warn('é”€æ¯ flv æ’­æ”¾å™¨å¤±è´¥', err);
                }
                flvPlayerInstance = null;
            }
        }

        function startFlvPlayback(url) {
            destroyFlvPlayer();
            if (playerVideo) {
                playerVideo.pause();
                playerVideo.removeAttribute('src');
                playerVideo.load();
            }

            if (playerOverlay) {
                playerOverlay.classList.remove('hidden');
                playerOverlay.setAttribute('aria-hidden', 'false');
            }
            if (playerStatus) {
                playerStatus.textContent = 'åŠ è½½ä¸­...';
            }

            if (window.flvjs && flvjs.isSupported()) {
                flvPlayerInstance = flvjs.createPlayer(
                    { type: 'flv', url, isLive: true },
                    { enableWorker: false }
                );
                flvPlayerInstance.attachMediaElement(playerVideo);
                flvPlayerInstance.load();
                flvPlayerInstance.play().catch(() => {});

                flvPlayerInstance.on(flvjs.Events.METADATA_ARRIVED, () => {
                    playerStatus.textContent = 'ç›´æ’­æµå·²å°±ç»ª';
                });
                flvPlayerInstance.on(flvjs.Events.ERROR, (type, detail) => {
                    playerStatus.textContent = `æ’­æ”¾å¼‚å¸¸ï¼š${detail || type}`;
                });
                flvPlayerInstance.on(flvjs.Events.LOADING_COMPLETE, () => {
                    playerStatus.textContent = 'ç›´æ’­ç»“æŸ';
                });
            } else {
                if (playerVideo) {
                    playerVideo.src = url;
                    playerVideo.play().catch(() => {});
                }
                if (playerStatus) {
                    playerStatus.textContent = 'å½“å‰ç¯å¢ƒä¸æ”¯æŒ flv.jsï¼Œå°è¯•åŸç”Ÿæ’­æ”¾';
                }
            }
        }

        function closePlayerModal() {
            destroyFlvPlayer();
            if (playerVideo) {
                playerVideo.pause();
                playerVideo.removeAttribute('src');
                playerVideo.load();
            }
            playbackContext = null;
            setActiveChannelButton(null);
            if (playerOverlay) {
                playerOverlay.classList.add('hidden');
                playerOverlay.setAttribute('aria-hidden', 'true');
            }
        }

        function startPlaybackForChannel(channel) {
            if (!playbackContext) {
                alert('æš‚æ— å¯æ’­æ”¾çš„æµ');
                return;
            }
            playbackContext.channel = channel;
            setActiveChannelButton(channel);

            const { serverIP, serverPort, vehicle, color, authCode } = playbackContext;
            const url = buildPlaybackURL({
                serverIP,
                serverPort,
                plate: vehicle,
                color,
                channel,
                avFlag: AUDIO_VIDEO_FLAG,
                authCode
            });

            if (playerTitle) {
                playerTitle.textContent = `è½¦è¾† ${vehicle} - é€šé“ ${channel}`;
            }
            if (playerInfo) {
                playerInfo.textContent = `æœåŠ¡å™¨ï¼š${serverIP}:${serverPort} | å£ä»¤ï¼š${authCode || 'æ— '}`;
            }
            startFlvPlayback(url);
        }

        function openLivePlayer(context) {
            ensurePlayerElements();
            if (!playerOverlay || !playerVideo || !playerStatus) {
                alert('æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥');
                return;
            }

            destroyFlvPlayer();
            if (playerVideo) {
                playerVideo.pause();
                playerVideo.removeAttribute('src');
                playerVideo.load();
            }

            playbackContext = { ...context, channel: null };
            setActiveChannelButton(null);

            if (playerTitle) {
                const vehicle = context?.vehicle || '';
                playerTitle.textContent = vehicle ? `è½¦è¾† ${vehicle} - é€‰æ‹©é€šé“` : 'ç›´æ’­æ’­æ”¾';
            }
            if (playerInfo) {
                const serverIP = context?.serverIP || '';
                const serverPort = context?.serverPort || '';
                const authCode = context?.authCode || '';
                playerInfo.textContent = serverIP ? `æœåŠ¡å™¨ï¼š${serverIP}:${serverPort} | å£ä»¤ï¼š${authCode || 'æ— '}` : '';
            }
            if (playerStatus) {
                playerStatus.textContent = 'è¯·é€‰æ‹©é€šé“å¼€å§‹æ’­æ”¾';
            }
            if (playerOverlay) {
                playerOverlay.classList.remove('hidden');
                playerOverlay.setAttribute('aria-hidden', 'false');
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span class="toast-emoji">âœ…</span><span>${message}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 2500);
        }

        function pickChannel() {
            return new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.innerHTML = `
                    <div class="modal">
                        <div class="modal-title">è¯·é€‰æ‹©é€šé“</div>
                        <div class="channel-grid">
                            <button class="channel-btn" data-channel="1">é€šé“ 1</button>
                            <button class="channel-btn" data-channel="2">é€šé“ 2</button>
                            <button class="channel-btn" data-channel="3">é€šé“ 3</button>
                            <button class="channel-btn" data-channel="4">é€šé“ 4</button>
                        </div>
                        <div class="modal-actions">
                            <button class="modal-cancel">å–æ¶ˆ</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);

                function cleanup(val) {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    resolve(val);
                }

                overlay.querySelectorAll('.channel-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const val = Number(btn.dataset.channel);
                        btn.textContent = `âœ… é€šé“ ${val}`;
                        btn.disabled = true;
                        overlay.querySelectorAll('.channel-btn').forEach(b => {
                            if (b !== btn) b.disabled = true;
                        });
                        setTimeout(() => cleanup(val), 240);
                    });
                });

                overlay.querySelector('.modal-cancel').addEventListener('click', () => cleanup(null));
                overlay.addEventListener('click', e => {
                    if (e.target === overlay) {
                        cleanup(null);
                    }
                });
            });
        }

        async function handleVideoRequest(button) {
            const userId = Number(button.dataset.userId);
            const vehicle = button.dataset.vehicle;
            const color = Number(button.dataset.color) || 2;

            if (!vehicle) {
                alert('ç¼ºå°‘è½¦ç‰Œä¿¡æ¯ï¼Œæ— æ³•ç‚¹æ’­');
                return;
            }

            const originalText = button.textContent;
            button.textContent = 'ç‚¹æ’­ä¸­...';
            button.disabled = true;
            try {
                const resp = await fetch('/api/video/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        vehicle_no: vehicle,
                        vehicle_color: color,
                        channel_id: 0,
                        av_item_type: 2
                    })
                });
                if (!resp.ok) {
                    const msg = await resp.text();
                    throw new Error(msg || 'ç‚¹æ’­å¤±è´¥');
                }
                button.textContent = 'å·²ç‚¹æ’­';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 1200);
            } catch (err) {
                alert('ç‚¹æ’­å¤±è´¥ï¼š' + err.message);
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function handlePlay(button) {
            const serverIP = button.dataset.serverIp;
            const serverPort = button.dataset.serverPort;
            const vehicle = button.dataset.vehicle;
            const color = Number(button.dataset.color) || 2;
            const authCode = button.dataset.auth;

            if (!serverIP || !serverPort || !vehicle || !authCode) {
                alert('ç¼ºå°‘è§†é¢‘åœ°å€æˆ–æ—¶æ•ˆå£ä»¤ï¼Œè¯·å…ˆå®Œæˆç‚¹æ’­å¹¶ç­‰å¾…è§†é¢‘åœ°å€è¿”å›');
                return;
            }

            openLivePlayer({
                serverIP,
                serverPort,
                vehicle,
                color,
                authCode
            });
        }

        // è·å–è½¦ç‰Œé¢œè‰²ä¿¡æ¯
        function getVehicleColor(color) {
            return vehicleColorMap[color] || { name: 'æœªçŸ¥', class: 'color-4' };
        }

        // æ¸²æŸ“è½¦è¾†è¡¨æ ¼
        function renderVehicles(platform) {
            const vehicles = platform?.vehicles || [];
            if (!vehicles || vehicles.length === 0) {
                return '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div>æš‚æ— è½¦è¾†æ•°æ®</div></div>';
            }

            // æŒ‰ç…§æ³¨å†Œæ—¶é—´å€’åºæ’åºï¼ˆæœ€æ–°æ³¨å†Œçš„åœ¨å‰ï¼‰
            const sortedVehicles = [...vehicles].sort((a, b) => {
                // å…¼å®¹ä¸åŒçš„å­—æ®µåæ ¼å¼
                const timeA = a.registration?.ReceivedAt || a.registration?.received_at ||
                             a.registration?.receivedAt || '';
                const timeB = b.registration?.ReceivedAt || b.registration?.received_at ||
                             b.registration?.receivedAt || '';

                // å¦‚æœéƒ½æ²¡æœ‰æ³¨å†Œæ—¶é—´ï¼ŒæŒ‰è½¦ç‰Œå·æ’åº
                if (!timeA && !timeB) {
                    const noA = a.vehicle_no || '';
                    const noB = b.vehicle_no || '';
                    return noA.localeCompare(noB);
                }
                if (!timeA) return 1;  // æ²¡æœ‰æ³¨å†Œæ—¶é—´çš„æ’åé¢
                if (!timeB) return -1;

                // å€’åºæ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
                return new Date(timeB) - new Date(timeA);
            });

            let html = `
                <div class="vehicles-header">è½¦è¾†åˆ—è¡¨ (${vehicles.length})</div>
                <table class="vehicles-table">
                    <thead>
                        <tr>
                            <th>è½¦ç‰Œå·</th>
                            <th>é¢œè‰²</th>
                            <th>ä½ç½®</th>
                            <th>å®šä½æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedVehicles.forEach(vehicle => {
                const colorInfo = getVehicleColor(vehicle.vehicle_color);
                const location = vehicle.longitude && vehicle.latitude
                    ? `${formatCoord(vehicle.latitude)}, ${formatCoord(vehicle.longitude)}`
                    : 'N/A';

                const vehicleNo = vehicle.vehicle_no || 'N/A';
                const hasPlate = vehicleNo !== 'N/A';
                const videoAck = vehicle.video_ack || {};
                const serverIP = videoAck.server_ip || videoAck.ServerIP || '';
                const serverPort = videoAck.server_port || videoAck.ServerPort || '';
                const hasVideoAddress = !!(serverIP && serverPort);
                const canPlay = hasVideoAddress && platform.auth_code && hasPlate;
                const playDisabled = canPlay ? '' : 'disabled';
                const requestDisabled = hasPlate ? '' : 'disabled';

                html += `
                    <tr>
                        <td>
                            <span class="copyable">
                                <strong>${vehicleNo}</strong>
                                ${vehicleNo !== 'N/A' ? createCopyButton(vehicleNo) : ''}
                            </span>
                        </td>
                        <td><span class="vehicle-color ${colorInfo.class}">${colorInfo.name}</span></td>
                        <td class="coord">${location}</td>
                        <td class="time">${formatTime(vehicle.location_time)}</td>
                        <td>
                            <div class="action-cell">
                                <button
                                    class="action-btn"
                                    data-user-id="${platform.user_id}"
                                    data-vehicle="${escapeAttr(vehicleNo)}"
                                    data-color="${vehicle.vehicle_color}"
                                    onclick="handleVideoRequest(this)"
                                    ${requestDisabled}
                                >
                                    ç‚¹æ’­
                                </button>
                                <button
                                    class="action-btn action-play"
                                    data-user-id="${platform.user_id}"
                                    data-vehicle="${escapeAttr(vehicleNo)}"
                                    data-color="${vehicle.vehicle_color}"
                                    data-auth="${escapeAttr(platform.auth_code || '')}"
                                    data-server-ip="${escapeAttr(serverIP)}"
                                    data-server-port="${serverPort}"
                                    onclick="handlePlay(this)"
                                    ${playDisabled}
                                    title="${canPlay ? 'ç‚¹æ’­åå¼¹çª—æ’­æ”¾' : 'ç‚¹æ’­æˆåŠŸå¹¶è¿”å›è§†é¢‘åœ°å€åå¯ç”¨'}"
                                >
                                    æ’­æ”¾
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        // æ¸²æŸ“å¹³å°å¡ç‰‡
        function renderPlatform(platform) {
            const isOnline = platform.sub_connected;
            const mainHeartbeat = formatTime(platform.last_main_heartbeat);
            const subHeartbeat = formatTime(platform.last_sub_heartbeat);
            const vehicleCount = platform.vehicles ? platform.vehicles.length : 0;

            return `
                <div class="platform-card" data-platform-id="${platform.user_id}">
                    <div class="platform-header">
                        <div class="platform-info">
                            <div class="platform-title" onclick="togglePlatform(${platform.user_id})" style="cursor: pointer;">
                                å¹³å° #${platform.user_id}
                                <span class="expand-icon">â–¼</span>
                            </div>
                            <div class="platform-id">
                                ${platform.platform_id ? `å¹³å°ç¼–ç : ${platform.platform_id}` : ''}
                            </div>
                            <div class="platform-id">
                                ä¼šè¯ID: ${platform.main_session_id || 'N/A'}
                            </div>
                        </div>

                        <div class="status-group">
                            <div class="status-item">
                                <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                                <span class="status-label">ä¸»é“¾è·¯:</span>
                                <span class="status-value">${platform.main_session_id ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</span>
                            </div>
                            <div class="heartbeat-info">æœ€åå¿ƒè·³: ${mainHeartbeat}</div>

                            <div class="status-item">
                                <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                                <span class="status-label">ä»é“¾è·¯:</span>
                                <span class="status-value">${isOnline ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</span>
                            </div>
                            <div class="heartbeat-info">æœ€åå¿ƒè·³: ${subHeartbeat}</div>
                        </div>

                        <div class="link-info">
                            <div class="link-info-item">
                                <span class="link-info-label">ä¸‹è¡ŒIP:</span> ${platform.down_link_ip || 'N/A'}
                            </div>
                            <div class="link-info-item">
                                <span class="link-info-label">ä¸‹è¡Œç«¯å£:</span> ${platform.down_link_port || 'N/A'}
                            </div>
                            <div class="link-info-item">
                                <span class="link-info-label">GNSSä¸­å¿ƒID:</span> ${platform.gnss_center_id || 'N/A'}
                            </div>
                            ${platform.auth_code ? `
                            <div class="link-info-item">
                                <span class="link-info-label">æ—¶æ•ˆå£ä»¤:</span>
                                <span class="copyable">
                                    ${platform.auth_code}
                                    ${createCopyButton(platform.auth_code)}
                                </span>
                            </div>
                            ` : ''}
                        </div>

                        <div class="status-group">
                            <div class="status-item">
                                <span class="badge badge-info">è½¦è¾†: ${vehicleCount}</span>
                            </div>
                        </div>
                    </div>

                    <div class="vehicles-section">
                        <div class="vehicles-container">
                            ${renderVehicles(platform)}
                        </div>
                    </div>
                </div>
            `;
        }

        // åˆ‡æ¢å¹³å°å±•å¼€/æŠ˜å 
        function togglePlatform(platformId) {
            const card = document.querySelector(`[data-platform-id="${platformId}"]`);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // ä¿å­˜å½“å‰å±•å¼€çŠ¶æ€
                const expandedPlatforms = new Set();
                document.querySelectorAll('.platform-card.expanded').forEach(card => {
                    expandedPlatforms.add(card.dataset.platformId);
                });

                const response = await fetch(`/api/platforms?ts=${Date.now()}`, { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const platforms = await response.json();

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                let onlineCount = 0;
                let totalVehicles = 0;
                let monitoredCount = 0;

                platforms.forEach(platform => {
                    if (platform.sub_connected) onlineCount++;
                    if (platform.vehicles) {
                        totalVehicles += platform.vehicles.length;
                        monitoredCount += platform.vehicles.filter(v => v.monitored).length;
                    }
                });

                document.getElementById('onlinePlatforms').textContent = onlineCount;
                document.getElementById('totalPlatforms').textContent = platforms.length;
                document.getElementById('totalVehicles').textContent = totalVehicles;
                document.getElementById('monitoredVehicles').textContent = monitoredCount;

                // æ¸²æŸ“å¹³å°åˆ—è¡¨
                const container = document.getElementById('platformsContainer');
                if (platforms.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div>æš‚æ— å¹³å°æ•°æ®</div></div>';
                } else {
                    container.innerHTML = platforms.map(platform => renderPlatform(platform)).join('');

                    // æ¢å¤å±•å¼€çŠ¶æ€
                    expandedPlatforms.forEach(platformId => {
                        const card = document.querySelector(`[data-platform-id="${platformId}"]`);
                        if (card) {
                            card.classList.add('expanded');
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('platformsContainer').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div>åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div></div>';
            }
        }

        // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
        function setupAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            const interval = document.getElementById('refreshInterval');

            function updateAutoRefresh() {
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                }

                if (toggle.checked) {
                    const seconds = parseInt(interval.value);
                    autoRefreshTimer = setInterval(loadData, seconds * 1000);
                }
            }

            toggle.addEventListener('change', updateAutoRefresh);
            interval.addEventListener('change', updateAutoRefresh);

            updateAutoRefresh();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupAutoRefresh();
        });
    </script>
</body>
</html>
