# JTT1078 视频代理服务器

JTT1078 是一个高性能的视频代理服务器，专为处理 JT/T 1078-2016 标准的视频流而设计。它支持实时视频流转发、GOP 缓存优化、FLV 封装以及智能时间戳修复等功能。

## 🌟 主要特性

- **视频秒开**: 利用 GOP 缓存技术实现即时播放
- **多路复用**: 支持同时为多个客户端提供视频流服务
- **延迟自动修复**: 智能时间戳修复机制确保流畅播放
- **全链路日志**: 详细的日志记录便于监控和调试
- **自动资源管理**: 无人观看时自动释放流资源

## 🚀 快速开始

```go
import "github.com/zboyco/jtt809/pkg/jtt1078"

// 创建视频服务器实例
server := jtt1078.NewVideoServer(":8080")

// 启动服务器
err := server.Start()
if err != nil {
    log.Fatal(err)
}
```

## 📡 API 接口

### 原始 H.264 流
```
GET /proxy?url={rtsp://source_url}
```
返回原始 H.264 视频流，适用于支持直接 H.264 解码的播放器。

### FLV 封装流
```
GET /proxy.flv?url={rtsp://source_url}
```
返回 FLV 封装的视频流，适用于大多数 Web 播放器。

## 🔧 核心组件

### VideoServer
主服务器组件，负责处理 HTTP 请求和管理流媒体连接。

### StreamManager
流管理器，负责维护所有活动的视频流。

### Broadcaster
广播器，负责从源拉取视频流并广播给所有订阅客户端。

### FlvMuxer
FLV 封装器，负责将 H.264 帧封装成 FLV 格式，并处理时间戳修复。

## ⚙️ 技术细节

### GOP 缓存机制
- 缓存最新的关键帧及其后续帧组(GOP)
- 新客户端连接时立即发送缓存内容实现秒开
- 自动清理过大的缓存防止内存泄漏

### 智能时间戳修复
- 区分突发模式(Burst)和直播模式(Live)
- 突发模式下强制按 30fps 间隔递增时间戳
- 直播模式下按实际时间差递增时间戳

### 资源自动回收
- 当无客户端订阅时自动停止拉流任务
- 自动清理不再使用的流资源

## 📊 日志系统

服务器内置详细的日志系统，记录以下事件：
- 新流启动
- 客户端加入/离开
- 流量统计心跳
- 源连接状态变化

## 🛠️ 使用示例

```bash
# 播放原始 H.264 流
curl "http://localhost:8080/proxy?url=rtsp://example.com/stream"

# 播放 FLV 流 (适用于 Web 播放器)
curl "http://localhost:8080/proxy.flv?url=rtsp://example.com/stream"
```

## 📈 性能特点

- 低延迟: 优化的数据传输路径
- 高并发: 支持大量客户端同时观看
- 内存效率: 智能缓存管理和资源回收
- 稳定性强: 异常处理和自动恢复机制